# Operator Runbook

Operational runbook for installing, validating, operating, and rolling back the Logs Viewer app.

Last updated: 2026-02-27

## 1. Scope

This runbook covers:

- Installation and upgrade workflow
- Production configuration baseline
- Post-deploy validation
- Rollback procedures
- Troubleshooting and escalation data

This app is designed for self-hosted Rocket.Chat deployments with Loki reachable from app runtime.

## 2. Prerequisites

Before deployment:

1. Rocket.Chat instance with Apps enabled and app install permissions.
2. Loki endpoint reachable from Rocket.Chat runtime network path.
3. Log ingestion pipeline configured with expected labels used by `required_label_selector`.
4. Deployment operator has access to app settings and role/permission administration.
5. Runtime profile decision made (`strict`, `fallback`, or `off`) per environment.

Reference profiles: `docs/OPERATOR_PROFILES.md`.

## 3. Installation and upgrade

For first-time setup, follow `docs/DEPLOYMENT_QUICKSTART.md` first, then return here for operations cadence/rollback.

## 3.0 Preflight (do this before touching production)

1. Confirm target package exists: `ls -lh dist/logs-viewer_*.zip`
2. Confirm app setting plan is prepared (especially `external_component_url` and selector).
   - Recommended default for most users: external hosted URL (for example `https://<your-hosted-logs-viewer-url>`)
   - Optional advanced mode: `https://<rocketchat-host>/logs-viewer/` (see `docs/SAME_ORIGIN_SETUP.md`)
3. Confirm one allowed test user and one denied test user are ready.
4. Confirm rollback artifact/version is available.

## 3.1 Build and package

1. Install dependencies: `bun install`
2. Build artifacts: `bun run build`
3. Package app: `bun run package`

Output artifact is generated by `rc-apps` packaging workflow.

Packaging implementation notes:

- Packaging/deploy scripts use `rc-apps --experimental-native-compiler`.
- `.rcappsconfig` controls ignored paths so non-app workspace files are not added to the zip.

## 3.2 Deploy

Use one deployment path:

1. CLI path: run `bun run deploy` and complete `rc-apps` prompts.
2. Admin UI path: upload `dist/logs-viewer_<version>.zip` in Rocket.Chat private app upload screen.
3. Confirm app status is `enabled`.
4. Confirm app version matches expected release.

## 3.3 Configure settings

Set required settings immediately after deploy:

1. `logs_source_mode` (`loki` or `app_logs`)
2. `loki_base_url`
3. `required_label_selector`
4. `external_component_url`
5. Authorization controls:
   - `allowed_roles`
   - `workspace_permission_mode`
   - `workspace_permission_code`
6. Guardrails:
   - `max_time_window_hours`
   - `max_lines_per_query`
   - `query_timeout_ms`
   - `rate_limit_qpm`
7. Audit and redaction:
   - `audit_retention_days`
   - `audit_max_entries`
   - `enable_redaction`
   - `redaction_replacement`

Start from the production profile and only relax settings intentionally.

Recommended minimum values for first production boot:

```text
logs_source_mode=loki
loki_base_url=https://<loki-host-or-observability-gateway>
required_label_selector={job="rocketchat"}
external_component_url=https://<your-hosted-logs-viewer-url>
allowed_roles=admin,log-viewer
workspace_permission_mode=strict
workspace_permission_code=view-logs
```

If running without Loki, set:

```text
logs_source_mode=app_logs
external_component_url=https://<your-hosted-logs-viewer-url>
allowed_roles=admin,log-viewer
workspace_permission_mode=strict
workspace_permission_code=view-logs
```

Source mode notes:

- `loki` (default): requires Loki URL/selector readiness and ingress query path exposure.
- `app_logs`: uses Rocket.Chat app lifecycle logs API and does not require Loki settings for query execution.

`loki_base_url` guidance:

- Use only the Loki host/base origin (for example `https://loki.example.com`), not full API paths.
- Do not append `/loki/api/v1/query_range`; the app composes query paths internally.
- Ensure the upstream ingress/proxy exposes Loki read APIs used by this app (`/loki/api/v1/query_range`, optionally `/loki/api/v1/query`).

## 3.4 Permission assignment

1. Ensure intended operator roles include `view-logs`.
2. Ensure non-operator roles do not include `view-logs`.
3. Validate command visibility boundaries with one allowed and one denied test user.

## 4. Post-deploy validation

Run this smoke suite after install or upgrade:

1. Authorization check:
   - Allowed user can run `/logs` and open viewer.
   - Denied user cannot access logs endpoints/workflow.
   - Slash response remains private to invoking user (no room-visible `/logs` output message).
   - Slash card buttons are visible and functional for allowed user:
     - `Show copy-ready sample` sends private response.
     - `Share sample` posts evidence to room/thread and writes audit entry.
     - `Share elsewhere` opens private modal and posts to target room/thread (membership-validated) with audit entry.
2. Query check:
   - Relative query returns results or empty success response.
   - Oversized limit/time range is rejected by guardrails.
   - Slash summary shows sample preview (up to 25 lines) for Loki mode.
   - Results panel readability controls work:
     - pretty/raw toggle
     - wrap on/off
     - row expand/collapse
     - copy line
3. Audit check:
   - One allowed and one denied event appear in `/audit`.
4. Redaction check:
   - Known sensitive token pattern is redacted in returned entries.
5. Workflow check:
   - Row action posts successfully to allowed room/thread.
   - Saved view create/apply/update/delete works for allowed user.
6. Polling check:
   - Live polling starts in relative mode and stops on explicit stop.
   - Absolute mode does not allow live polling.

If any check fails, treat rollout as incomplete and follow troubleshooting section.

## 4.1 Field-validated reference (2026-02-25)

Validated in active environments during implementation:

1. Loki ingress query path exposure was healthy; query APIs were exposed and reachable.
2. A `returned: 0` outcome in UI was traced to label selector mismatch, not ingress failure.
3. Working selector example pattern for tested environments:
   - `required_label_selector={cluster="<cluster-name>",namespace="rocketchat"}`
4. `app_logs` source mode worked as expected as operational fallback.
5. Rocket.Chat pod logs can be high-volume and repetitive during active UI/admin usage:
   - keep sidebar preview concise for scan speed (25 lines)
   - use full-line-priority copy/share evidence rendering (up to 40 lines) for incident handoff
   - keep slash action payload small by relying on persisted per-user sample snapshots

Operator takeaway:

- If ingestion appears healthy but query returns empty results, validate selector labels first.
- Do not assume `{job="rocketchat"}` exists in every pipeline.
- Prefer filtered evidence sharing (`search` + `level`) before posting long samples to rooms.

## 5. Change management

For each production change:

1. Record current app version and non-secret settings snapshot.
2. Record intended changes and risk notes.
3. Apply change in staging first when available.
4. Execute post-deploy validation in section 4.
5. Log completion result and rollback readiness.
6. Update release records following `docs/RELEASE_WORKFLOW.md`.

## 6. Rollback procedures

Use the least disruptive rollback first.

## 6.1 Configuration rollback (fastest)

Use when behavior regression is tied to settings:

1. Revert changed settings to last known-good values.
2. For authorization transport issues in strict mode, temporarily switch to `fallback`.
3. Re-run smoke checks (authorization + query + audit).

## 6.2 Version rollback

Use when regression is code-level:

1. Deploy last known-good app package version.
2. Confirm app enables successfully.
3. Re-apply known-good settings profile.
4. Re-run smoke checks in section 4.

## 6.3 Emergency disable

Use when immediate risk reduction is required:

1. Disable app in Rocket.Chat admin UI.
2. Communicate temporary unavailability to operators.
3. Preserve logs/audit evidence for root-cause review.

## 7. Troubleshooting

## 7.1 Authorization and RBAC

Symptom: `Insufficient authorization ...` errors.

Checks:

1. Verify user role is included in `allowed_roles`.
2. Verify role has permission code `view-logs`.
3. Verify `workspace_permission_mode` behavior is intentional.
4. In `strict`, verify permission lookup prerequisites:
   - valid auth headers in app API calls
   - resolvable site origin
   - reachable permissions API

Reference: `docs/RBAC_REVIEW.md`.

## 7.2 Loki connectivity and selector issues

Symptom: Loki upstream errors or invalid config responses.

Checks:

1. Confirm `loki_base_url` is reachable from runtime network path.
2. Confirm credentials (if configured) are valid.
3. Confirm `required_label_selector` syntax is valid and matches ingestion labels.
4. Validate with a narrow relative query (`since=15m`, low limit).
5. If upstream returns `404`, verify your Loki ingress exposes query APIs, not only ingest (`/loki/api/v1/push`).
6. If query returns success but `returned=0`, inspect live labels and adjust selector:
   - check available labels/values via Loki API (`/loki/api/v1/labels`, `/loki/api/v1/label/<name>/values`)
   - align selector to real ingestion labels (for example cluster + namespace scoping).

## 7.3 Guardrail and rate limit failures

Symptom: `429` or query rejected for limits/time window.

Checks:

1. Confirm operator behavior is within configured `rate_limit_qpm`.
2. Narrow time window and lower `limit`.
3. Review whether guardrail values are too strict for operational use.

## 7.4 Row action and thread targeting failures

Symptom: action rejects room/thread target.

Checks:

1. Confirm target room exists and user is a member.
2. Confirm thread ID belongs to selected room.
3. For `thread_note`, ensure `targetThreadId` is provided.

## 7.5 Slash card button failures (`Show copy-ready sample` / `Share sample`)

Symptom: button appears but no expected output is produced.

Checks:

1. Confirm app is on latest uploaded package and enabled.
2. Re-run `/logs` to regenerate fresh interaction context, then click again.
3. Confirm user is in `allowed_roles` and has `view-logs` permission.
4. Confirm room context exists and user is member of target room for share path.
5. Inspect app logs for block-action processing around click timestamp (`executeBlockActionHandler` path).
6. If action says snapshot is unavailable, the slash card is stale; run `/logs` again to create a fresh per-user sample snapshot.

Notes:

- `Show copy-ready sample` is always private.
- `Share sample` is room/thread-visible and audited.
- Clipboard writes are not possible from Rocket.Chat Apps block actions; `Show copy-ready sample` returns a private copy-ready block.
- If logs show `error-message-size-exceeded`, sample output exceeded workspace message-size limits; use the latest build with automatic chat-size truncation.

## 7.6 Share elsewhere failures

Symptom: submit from `Share elsewhere` modal does not post evidence.

Checks:

1. Confirm target room is accessible by the acting user (membership required).
2. If target uses room name, verify exact display/slug spelling.
3. If target thread ID is provided, verify it belongs to the selected room.
4. If app reports request expired, rerun `/logs` and reopen `Share elsewhere`.
5. Check app logs for:
   - `room_access_denied`
   - `thread_invalid`
   - `publish_failed`

## 7.7 Packaging and release build failures

Symptom: `bun run package` fails with compiler/module resolution errors.

Checks:

1. Confirm `@rocket.chat/apps-engine` is defined under `devDependencies` in `package.json`.
2. Confirm package/deploy scripts include `--experimental-native-compiler`.
3. Confirm `.rcappsconfig` exists and ignores workspace-only paths (`web/**`, `tests/**`, docs).
4. Re-run in order:
   - `bun run test`
   - `bun run typecheck`
   - `bun run build`
   - `bun run package`

Expected warning:

- `No package-lock.json found` is expected in this Bun-first setup and is not a package failure by itself.

## 7.8 Local development CORS failures

Symptom: browser console shows `No 'Access-Control-Allow-Origin' header` for calls from `http://localhost:5173` to Rocket.Chat app API.

Checks:

1. Choose one local auth mode:
   - Cookie mode:
     - `VITE_ROCKETCHAT_API_ORIGIN=https://<rocketchat-host> bun run dev:web`
     - Requires Rocket.Chat CORS allowlist to include `http://localhost:5173`.
   - Token mode (recommended for localhost):
     - `VITE_ROCKETCHAT_API_ORIGIN=https://<rocketchat-host>`
     - `VITE_ROCKETCHAT_USER_ID=<rc-user-id>`
     - `VITE_ROCKETCHAT_AUTH_TOKEN=<personal-access-token-or-auth-token>`
     - `bun run dev:web`
2. In token mode, confirm browser requests are same-origin path style:
   - `/api/apps/public/<appId>/config` or `/api/apps/private/<appId>/config`
   - client attempts private first, then public on `404`.
3. If your workspace exposes tokenized private routes, set:
   - `VITE_ROCKETCHAT_APP_API_BASE_PATH=<exact-base-path>`
4. Restart dev server after changing any `VITE_*` variables or `web/vite.config.ts`.

## 7.9 High `[unknown]` level ratio in slash summary

Symptom: slash sample lines frequently show level `[unknown]`.

Checks:

1. Confirm log payload includes either:
   - a string severity label (`error|warn|info|debug`), or
   - a numeric level value (`20/30/35/40/50` style).
2. Confirm ingested payload format is valid JSON when numeric levels are expected.
3. Confirm label keys are not being renamed/stripped by pipeline transforms.
4. Use `search` or `level` filters to reduce noise before sharing evidence.

Notes:

- Slash summary maps common numeric levels to semantic values:
  - `20 -> debug`
  - `30/35 -> info`
  - `40 -> warn`
  - `50+ -> error`
- If none of these are present, `[unknown]` is expected fallback behavior.

## 7.10 Same-origin viewer shows `HTTP 401`

Symptom: web UI loads, but banner shows `Config unavailable` with `HTTP 401`.

Checks:

1. Confirm user is logged into Rocket.Chat in the same browser profile and same origin host.
2. Re-open viewer from fresh `/logs` response (avoid stale tab/profile context).
3. Confirm viewer runtime shows app API path and not a foreign origin.
4. If your environment blocks session-storage auth propagation to this route, run web UI in token mode:
   - `VITE_ROCKETCHAT_API_ORIGIN=https://<rocketchat-host>`
   - `VITE_ROCKETCHAT_USER_ID=<rc-user-id>`
   - `VITE_ROCKETCHAT_AUTH_TOKEN=<personal-access-token-or-auth-token>`

Notes:

- Current web client attempts same-origin storage-based auth first, and can fall back between private/public app base paths for compatibility.
- `401` means authentication context was not accepted; `403` means authenticated but denied by role/workspace-permission policy.

## 8. Escalation data collection

When escalating an incident, collect:

1. App version and deployment timestamp.
2. Effective non-secret settings snapshot.
3. Exact error message and HTTP status.
4. Relevant `/audit` entries for the incident window.
5. Reproducible request context (`since/start/end`, `limit`, `level`, `search`).
6. Whether issue reproduces in `fallback` mode (authorization-path diagnosis).

Do not include Loki secrets or auth tokens in incident tickets.

## 9. Operations cadence

Recommended routine:

1. Weekly:
   - Review denied audit trends and rate-limit spikes.
   - Confirm redaction remains enabled in production.
2. Monthly:
   - Re-validate role and permission assignments.
   - Re-check required labels against ingestion pipeline changes.
3. Per release:
   - Execute full post-deploy smoke suite.
   - Execute release documentation steps in `docs/RELEASE_WORKFLOW.md`.
   - Update runbook and checklist docs with any behavior changes.
   - Update `docs/VERSION_TRACKER.md` and confirm `docs/GITHUB_PUSH_PLAN.md` still matches team process.
4. Upstream/community watch:
   - Review `docs/COMMUNITY_INTELLIGENCE.md` and refresh references for product/API changes that could affect this app.
   - Update the candidate issues watchlist with newly observed community or field patterns.
   - Re-confirm `P1` watchlist owners and mitigation status before each release.
